"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _getUserConfigPlugins = _interopRequireDefault(require("af-webpack/getUserConfigPlugins"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const plugins = (0, _getUserConfigPlugins.default)();

function noop() {
  return true;
}

const excludes = ['entry', 'outputPath', 'hash'];

function _default(api) {
  const debug = api.utils.debug;
  api.register('modifyConfigPlugins', ({
    memo
  }) => {
    plugins.forEach(({
      name,
      validate = noop
    }) => {
      if (!excludes.includes(name)) {
        memo.push(() => ({
          name,
          validate,

          onChange(newConfig) {
            try {
              debug(`Config ${name} changed to ${JSON.stringify(newConfig[name])}`);
            } catch (e) {}

            if (name === 'proxy') {
              global.g_umi_reloadProxy(newConfig[name]);
            } else {
              api.service.restart(`${name} changed`);
            }
          }

        }));
      }
    });
    return memo;
  });
}