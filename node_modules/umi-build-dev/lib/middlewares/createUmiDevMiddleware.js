"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createUmiDevMiddleware;

var _reactRouterConfig = require("react-router-config");

var _requestCache = require("../requestCache");

const COMPILING_PREFIX = '/__umi_dev/compiling';

function createUmiDevMiddleware(service, opts = {}) {
  const config = service.config;
  return (req, res, next) => {
    const path = req.path;

    if (!path.startsWith(COMPILING_PREFIX)) {
      return next();
    }

    const routePath = path.replace(COMPILING_PREFIX, '');
    const matchedRoutes = (0, _reactRouterConfig.matchRoutes)(service.routes, routePath);

    if (matchedRoutes && matchedRoutes.length) {
      matchedRoutes.forEach(({
        route
      }) => {
        let newPath = null;

        if (config.exportStatic && config.exportStatic.htmlSuffix) {
          newPath = route.path.replace('(.html)?', '');
        }

        if (route.path) (0, _requestCache.setRequest)(newPath || route.path);
      });
      opts.rebuildEntry();
    }

    res.end('done');
  };
}